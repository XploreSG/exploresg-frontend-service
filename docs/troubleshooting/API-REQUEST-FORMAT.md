# API Request Format Confirmation

## ‚ö†Ô∏è CRITICAL REQUIREMENT: carModelPublicId Must Be Exact Match

**The backend requires `carModelPublicId` to EXACTLY match the UUID from the backend database, otherwise the booking will error out.**

### Backend Expectation

- **Field**: `carModelPublicId`
- **Type**: UUID string
- **Example**: `"123e4567-e89b-12d3-a456-426614174000"`
- **Source**: Must come from backend's `publicId` field in car model data

### ‚ùå INCORRECT (Will Cause Errors)

```json
{
  "carModelPublicId": "101-5" // Frontend-generated ID - WRONG!
}
```

### ‚úÖ CORRECT

```json
{
  "carModelPublicId": "123e4567-e89b-12d3-a456-426614174000" // Backend UUID - CORRECT!
}
```

## Booking API Request Format ‚úÖ

### What the Frontend is Sending

When the user clicks "Reserve Vehicle" on the ReviewPage, the frontend sends this exact format:

```json
{
  "carModelPublicId": "123e4567-e89b-12d3-a456-426614174000",
  "startDate": "2025-11-01T10:00:00.000Z",
  "endDate": "2025-11-05T18:00:00.000Z",
  "pickupLocation": "Changi Airport",
  "returnLocation": "Changi Airport",
  "driverDetails": {
    "firstName": "John",
    "lastName": "Doe",
    "email": "john.doe@example.com",
    "phone": "+65 9123 4567",
    "licenseNumber": "S1234567A",
    "dateOfBirth": "1990-01-15",
    "licenseExpiryDate": "2030-12-31"
  },
  "selectedCDW": "basic",
  "selectedAddOns": ["malaysia-drive", "windscreen-protector"]
}
```

### Date Format Details

**‚úÖ CONFIRMED: Frontend sends ISO 8601 format**

- **startDate**: `"2025-11-01T10:00:00.000Z"` (ISO 8601 with timezone)
- **endDate**: `"2025-11-05T18:00:00.000Z"` (ISO 8601 with timezone)

This is generated by:

```typescript
const pickupISO = new Date(pickupDate + "T" + pickupTime).toISOString();
const returnISO = new Date(returnDate + "T" + returnTime).toISOString();
```

### How It Works

#### 1. Backend Response (Fleet API)

```json
{
  "operatorId": "28dac4bd-e11a-4240-9602-c23fa8d8c510",
  "carModelId": 5,
  "publicId": "123e4567-e89b-12d3-a456-426614174000",  // ‚≠ê THIS is what we need!
  "model": "Toyota Alphard",
  ...
}
```

#### 2. Frontend Transform (transformCarModelData)

```tsx
{
  id: "101-5",  // Frontend display ID
  carModelPublicId: "123e4567-e89b-12d3-a456-426614174000",  // ‚≠ê Passed through!
  model: "Toyota Alphard",
  ...
}
```

#### 3. VehicleGrid ‚Üí RentalCard

```tsx
<RentalCard
  carId={car.carModelPublicId || car.id}  // ‚≠ê Use publicId if available
  ...
/>
```

#### 4. BookingContext (selectedCar)

```tsx
{
  carId: "123e4567-e89b-12d3-a456-426614174000",  // ‚≠ê Backend UUID stored
  carModelPublicId: "123e4567-e89b-12d3-a456-426614174000",
  model: "Toyota Alphard",
  ...
}
```

#### 5. ReviewPage (API Call)

```tsx
const carModelId = selectedCar.carModelPublicId || selectedCar.carId;  // ‚≠ê Use publicId first!

const bookingRequest = {
  carModelPublicId: carModelId,  // ‚≠ê Sends backend UUID
  ...
};
```

### Data Flow Diagram

```
Backend (Fleet API)
    ‚Üì (publicId: UUID)
transformCarModelData()
    ‚Üì (carModelPublicId: UUID)
VehicleGrid
    ‚Üì (carId = carModelPublicId)
RentalCard
    ‚Üì (carDetails with carId)
BookingContext (setSelectedCar)
    ‚Üì (selectedCar.carModelPublicId)
ReviewPage
    ‚Üì (carModelPublicId: UUID)
Backend (Booking API) ‚úÖ
```

### DatePicker Component (User Input)

```tsx
// User selects:
pickupDate: "2025-11-01"  (HTML5 date input)
pickupTime: "10:00"       (HTML5 time input)
returnDate: "2025-11-05"
returnTime: "18:00"
```

#### 2. BookingContext Storage (Dual Format)

```tsx
setBookingDates({
  // Display format (for UI)
  pickup: "Fri, 1 Nov, 10:00",
  return: "Tue, 5 Nov, 18:00",

  // ISO format (for API)
  pickupISO: "2025-11-01T10:00:00.000Z",
  returnISO: "2025-11-05T18:00:00.000Z",

  nights: 4,
});
```

#### 3. ReviewPage (API Call)

```tsx
const bookingRequest: CreateBookingRequest = {
  carModelPublicId: selectedCar.carId,
  startDate: bookingDates.pickupISO,  // ‚úÖ ISO format
  endDate: bookingDates.returnISO,    // ‚úÖ ISO format
  pickupLocation: "Changi Airport",
  returnLocation: "Changi Airport",
  driverDetails: { ... },
  selectedCDW: "basic",
  selectedAddOns: ["..."]
};
```

### TypeScript Type Definition

```typescript
export interface CreateBookingRequest {
  carModelPublicId: string;
  startDate: string; // ISO 8601: "2025-11-01T10:00:00.000Z"
  endDate: string; // ISO 8601: "2025-11-05T18:00:00.000Z"
  pickupLocation: string;
  returnLocation: string;
  driverDetails: {
    firstName: string;
    lastName: string;
    email: string;
    phone: string;
    licenseNumber: string;
    dateOfBirth?: string;
    licenseExpiryDate?: string;
  };
  selectedAddOns?: string[]; // Array of add-on IDs
  selectedCDW?: string; // "basic" | "plus" | "max"
}
```

### Debugging/Verification

To see the exact request being sent, check the browser console for:

```
üì§ ReviewPage: Sending booking request to API:
{
  "carModelPublicId": "...",
  "startDate": "2025-11-01T10:00:00.000Z",
  "endDate": "2025-11-05T18:00:00.000Z",
  ...
}
```

### Backend Compatibility

**‚úÖ CONFIRMED: Format matches backend requirements**

The backend expects exactly this ISO 8601 format:

- ‚úÖ Includes date: `2025-11-01`
- ‚úÖ Includes time: `T10:00:00`
- ‚úÖ Includes timezone: `.000Z` (UTC)
- ‚úÖ Java can parse with: `Instant.parse()` or `@JsonFormat(pattern = "yyyy-MM-dd'T'HH:mm:ss.SSSXXX")`

### Example Test Case

```json
// Request
POST /api/v1/bookings
Authorization: Bearer eyJhbGc...
Content-Type: application/json

{
  "carModelPublicId": "alpha-001",
  "startDate": "2025-11-01T10:00:00.000Z",
  "endDate": "2025-11-05T18:00:00.000Z",
  "pickupLocation": "Changi Airport",
  "returnLocation": "Changi Airport",
  "driverDetails": {
    "firstName": "Jane",
    "lastName": "Smith",
    "email": "jane@example.com",
    "phone": "+65 9876 5432",
    "licenseNumber": "S9876543B",
    "dateOfBirth": "1995-05-20",
    "licenseExpiryDate": "2028-06-15"
  },
  "selectedCDW": "plus",
  "selectedAddOns": ["malaysia-drive", "windscreen-protector", "child-booster"]
}
```

## Status

‚úÖ **CONFIRMED**: Frontend sends dates in correct ISO 8601 format
‚úÖ **CONFIRMED**: TypeScript types match API contract
‚úÖ **CONFIRMED**: Console logging added for verification
‚úÖ **CONFIRMED**: Format is backend-compatible

## Files Modified

1. `src/contexts/bookingContextCore.ts` - Added `pickupISO` and `returnISO` fields
2. `src/components/VehicleBrowse/DatePickerSection.tsx` - Generates ISO format
3. `src/pages/ReviewPage.tsx` - Uses ISO format for API calls, added debug logging
4. `src/services/bookingApi.ts` - Type definition already correct

## Testing

To test the exact request format:

1. Navigate to `/rentals`
2. Select pickup/return dates
3. Select a vehicle
4. Fill in add-ons
5. Complete driver details
6. Click "Reserve Vehicle" on review page
7. Check browser console for: `üì§ ReviewPage: Sending booking request to API:`
8. Verify the `startDate` and `endDate` are in ISO format
